# 算法交易系统 (Algo-Trade)

基于机器学习的四层架构量化交易系统,支持多空策略和智能风控。

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────┐
│ L5: 元策略优化 (Meta-Strategy) ⭐ NEW                    │
│ • 模型: LGBMRegressor (多输出)                           │
│ • 输入: 市场特征 (波动率, VIX, 趋势等)                    │
│ • 输出: 动态参数 (signal_threshold, top_n, risk_factor) │
│ • 特性: 根据市场环境自动调整策略参数                      │
└─────────────────────────────────────────────────────────┘
                          ↓ (动态参数)
┌─────────────────────────────────────────────────────────┐
│ L1: 市场择时 (Market Timing)                              │
│ • 模型: RandomForest Classifier                          │
│ • 输入: SPY, VIXY, TLT 宏观数据                           │
│ • 输出: 市场环境安全性评估 + 宏观特征                      │
└─────────────────────────────────────────────────────────┘
                ↓ (安全评估)              ↓ (宏观特征)
┌─────────────────────────────────────────────────────────┐
│ L2: 选股排序 (Stock Selection)                           │
│ • 模型: LGBMRanker                                       │
│ • 输入: 12 只科技股的技术指标 + SMC 特征                   │
│ • 输出: 排序得分 → 做多(Top) + 做空(Bottom)               │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ L3: 趋势确认 (Trend Confirmation)                          │
│ • 模型: LGBMClassifier (3分类)                           │
│ • 输入: 1分钟线技术指标 + 洗盘检测                         │
│ • 输出: Long/Short/Neutral 置信度                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ L4: 动态仓位与风控 (Position & Risk)                      │
│ • 模型: LGBMRegressor (收益预测)                         │
│ • 输入: 技术指标 + SMC 特征 + L1 宏观特征 ⭐              │
│ • 输出: 预期收益率 → 动态仓位分配 + SMC 止盈止损            │
│ • 特性: 自动学习市场环境对收益的影响                       │
└─────────────────────────────────────────────────────────┘
```

### 🔄 多层协同机制

- **L5 → 参数优化**: 根据市场环境动态调整所有策略参数
- **L1 → 市场安全**: 决定是否降低整体仓位 (风险因子)
- **L1 → L4 特征**: 模型自动学习宏观环境对个股收益的影响
- **多重智能**: 参数自适应 + 显式风控 + 隐式学习

## 🚀 快速开始

### 安装依赖

```bash
make setup
```

### 训练模型

```bash
# 1. 训练基础模型
make train-l1  # 市场择时
make train-l2  # 选股排序
make train-l3  # 趋势确认
make train-l4  # 风控管理

# 2. 训练元策略 (L5)
make generate-meta-data  # 生成数据
make train-l5           # 训练 L5
```

### 🔧 超参数优化 (Optuna)

```bash
make optimize-l2  # 优化 L2 (自动保存最佳参数)
make optimize-l3  # 优化 L3
```

### 📈 回测策略

```bash
# 🚀 VectorBT 高速回测 (推荐)
make backtest-vbt days=30

# 经典回测 (显示交易明细)
make backtest tf=1h days=90 --details

# 自定义标的池
make backtest --symbols AAPL,TSLA,NVDA
```

### 运行预测

```bash
make predict
```

### 🤖 全自动交易 (Paper Trading)

系统现已支持基于 Alpaca 模拟盘的全自动交易，包含自动止盈止损。

```bash
# 启动自动交易 (默认 15 分钟/间隔)
make trade

# 自定义检查间隔
make trade args="--interval 5"
```

- **支架订单 (Bracket Orders)**: 入场时自动根据 L4 模型预测挂好 TP/SL 订单。
- **模拟盘保护**: 强制在 Alpaca Paper Trading 环境运行。
- **分层过滤**: 仅在 L1 + L3 置信度达标时触发交易。
- **持仓监控**: 每一轮检查都会展示当前持仓及其浮动盈亏。
- **动态仓位管理**: 根据账户总资产的 10% 自动计算下单股数，适配不同股价。
- **挂单检查**: 自动识别已有挂单，防止在信号触发但未成交时重复下单。

### 回测策略

```bash
# 默认: 1小时线, 90天, 多空策略
make backtest

# 显示交易明细
make backtest tf=1h days=90 --details

# 自定义标的池
make backtest --symbols AAPL,TSLA,NVDA
```

## 📊 核心特性

### 1. 多空策略

- **做多**: 选择排名最高的标的
- **做空**: 选择排名最低的标的
- **对冲收益**: `(做多收益 + 做空收益) / 2`

### 2. SMC (Smart Money Concepts) 特征

- **Swing High/Low**: 关键支撑阻力位
- **Order Blocks (OB)**: 机构订单区
- **Fair Value Gaps (FVG)**: 价格失衡区
- **Break of Structure (BOS)**: 市场结构突破
- **Displacement**: 大幅波动检测

### 3. 动态仓位与智能风控 (L4)

- **预期收益预测**: L4 模型预测未来 5 个周期的预期收益率
- **宏观环境感知**: 集成 L1 宏观特征 (SPY, VIXY, TLT),自动学习市场环境对收益的影响 ⭐
- **动态仓位分配**: 根据预期收益率自动匹配仓位比例 (2% - 15%)
- **智能风险调整**:
  - 牛市环境 → 预测更高收益 → 更大仓位
  - 熊市环境 → 预测更低收益 → 更小仓位
- **SMC 规则止损**: 将止损设在最近的 Swing High/Low 之外,避免被随机波动扫损
- **SMC 规则止盈**: 基于风险距离 (Risk) 和目标盈亏比 (R:R) 自动设置止盈

### 4. 洗盘检测

- **Bullish Shakeout**: 假跌破后反弹
- **Bearish Trap**: 假突破后回落

## 📁 项目结构

```
algo-trade/
├── data/
│   └── provider.py          # Alpaca 数据接口
├── features/
│   ├── technical.py         # 技术指标 + SMC 特征
│   └── macro.py             # 宏观指标
├── models/
│   ├── constants.py         # 统一配置 (标的池、阈值、参数)
│   ├── engine.py            # 策略引擎
│   ├── smc_rules.py         # SMC 止盈止损规则引擎 [NEW]
│   ├── trainer.py           # 模型训练器
│   └── artifacts/           # 训练好的模型
│       ├── l1_market_timing.joblib
│       ├── l2_stock_selection.joblib
│       ├── l3_execution.joblib
│       └── l4_risk_*.joblib
├── scripts/
│   ├── train_l1.py          # L1 训练脚本
│   ├── train_l2.py          # L2 训练脚本
│   ├── train_l3.py          # L3 训练脚本
│   ├── train_l4.py          # L4 训练脚本
│   └── backtest.py          # 回测脚本
├── utils/
│   └── logger.py            # 日志配置
├── predict.py               # 实时预测
├── trade.py                 # 自动交易
└── Makefile                 # 命令快捷方式
```

## 📅 训练数据时间范围

| 模型 | 数据周期  | 时间范围                | 说明               |
| ---- | --------- | ----------------------- | ------------------ |
| L1   | 日线      | 2022-12-31 ~ 2024-12-31 | 2 年宏观数据       |
| L2   | 小时线    | 2023-12-31 ~ 2024-12-31 | 1 年技术指标       |
| L3   | 15 分钟线 | 2024-07-03 ~ 2024-12-31 | 6 个月趋势确认信号 |
| L4   | 小时线    | 2023-12-31 ~ 2024-12-31 | 1 年止盈止损       |

> ℹ️ **2025 年数据用于样本外验证**，确保模型未见过测试数据。

## 🔧 配置

在项目根目录创建 `.env` 文件:

```env
ALPACA_API_KEY=your_api_key
ALPACA_SECRET_KEY=your_secret_key
```

## � 回测指标说明

| 指标             | 含义                   | 参考值               |
| ---------------- | ---------------------- | -------------------- |
| **策略累计收益** | 整个回测期间的总收益   | 跑赢基准             |
| **年化收益率**   | 按交易日折算的年化收益 | >15%                 |
| **最大回撤**     | 峰到谷的最大亏损       | <10%                 |
| **夏普比率**     | (收益-无风险率)/波动率 | >1.0 较好, >2.0 优秀 |
| **卡玛比率**     | 年化收益/最大回撤      | >1.0                 |
| **胜率**         | 盈利周期占总周期的比例 | >50%                 |
| **盈亏比**       | 总盈利/总亏损          | >1.5                 |

### 回测输出示例

```
============================================================
多空策略回测报告: 1h (Long 1 + Short 1) - ET
时间范围: 2025-12-08 08:00:00 至 2026-01-02 15:00:00
总周期数: 158
============================================================

📊 收益指标:
------------------------------------------------------------
  策略累计收益:     27.83%    SPY:   -0.52%    QQQ:   -2.32%
  年化收益率:       285.42%
  平均每周期:       0.1523%

📉 风险指标:
------------------------------------------------------------
  最大回撤:         -2.48%
  波动率 (std):     0.8234%
  最大连续亏损:          3 次

⚖️ 风险调整指标:
------------------------------------------------------------
  夏普比率:            7.52
  卡玛比率:          115.09
  盈亏比:             2.85

🎯 交易统计:
------------------------------------------------------------
  总交易周期:           158
  盈利周期:            98 (62.0%)
  亏损周期:            60 (38.0%)

============================================================
结论: 🏆 [策略成功跑赢所有基准!]

💡 调优建议:
  - ✅ 各项指标健康，可考虑扩大回测时间验证稳定性
============================================================
```

## 🎯 预测输出示例

```
[L1: 市场择时分析] ...
🟢 市场环境置信度: 64.0%
✅ 市场环境安全，正在进行选股分析...

[L2: 标的筛选分析] ...
� 基于 K 线时刻: 2024-12-27 15:00:00
--------------------------------------------------
排名 | 代码   | 价格      | 相对强度得分
--------------------------------------------------
1    | TSLA   | 431.70    | 0.0486 📈
2    | INTC   | 20.32     | -0.0256 📉
...

[L4: 风控建议计算] ...
� [做多建议] Top 1 高置信度标的:
------------------------------------------------------------
   [1] MU: 置信度 54.8% | 预期收益 -0.05% | 仓位 2%
       止盈 $93.04 (+4.98%) | 止损 $86.42 (-2.49%) | 盈亏比 2.00:1

📉 [做空建议] Top 3 高置信度标的:
------------------------------------------------------------
   [1] NVDA: 置信度 99.5% | 预期跌幅 0.08% | 仓位 2%
       止盈 $130.17 (-5.02%) | 止损 $140.50 (+2.51%) | 盈亏比 2.00:1

```

## 🛠️ 技术栈

- **数据源**: Alpaca Markets API
- **机器学习**: LightGBM, Scikit-learn
- **数据处理**: Pandas, NumPy
- **环境管理**: UV (Python package manager)

## 📝 开发路线图

- [x] L1 市场择时模型
- [x] L2 选股排序模型
- [x] L3 趋势确认模型
- [x] L4 风控管理模型
- [x] 多空策略回测
- [x] SMC 特征工程
- [x] 实盘自动交易接口 (Alpaca)
- [x] 仓位与风险管理优化
- [ ] Web 可视化界面
- [ ] 更多宏观因子集成

## ⚠️ 免责声明

本项目仅供学习和研究使用,不构成任何投资建议。实盘交易存在风险,请谨慎决策。

## 📄 许可证

MIT License
