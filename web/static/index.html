<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Algo Trade Dashboard</title>

    <!-- React & ReactDOM via CDN -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0e27;
        --bg-card: rgba(26, 31, 58, 0.8);
        --border-color: rgba(99, 102, 241, 0.2);
        --text-primary: #e2e8f0;
        --text-secondary: #94a3b8;
        --accent-blue: #6366f1;
        --accent-purple: #a855f7;
        --profit-green: #10b981;
        --loss-red: #ef4444;
        --warning-orange: #f59e0b;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(
          135deg,
          var(--bg-primary) 0%,
          #1a1f3a 50%,
          #0f172a 100%
        );
        color: var(--text-primary);
        min-height: 100vh;
      }

      .header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .header h1 {
        font-size: 1.75rem;
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .header-info {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .status-badge.open {
        background: rgba(16, 185, 129, 0.1);
        color: var(--profit-green);
      }
      .status-badge.closed {
        background: rgba(148, 163, 184, 0.1);
        color: var(--text-secondary);
      }
      .status-badge.safe {
        background: rgba(16, 185, 129, 0.1);
        color: var(--profit-green);
      }
      .status-badge.unsafe {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-orange);
      }

      .btn {
        background: var(--accent-blue);
        color: white;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
      }

      .btn:hover {
        background: var(--accent-purple);
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn.btn-secondary {
        background: rgba(99, 102, 241, 0.2);
        color: var(--accent-blue);
      }

      .btn.btn-secondary:hover {
        background: rgba(168, 85, 247, 0.2);
        color: var(--accent-purple);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* æ ‡ç­¾é¡µå¯¼èˆª */
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
        overflow-x: auto;
      }

      .tab {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        white-space: nowrap;
      }

      .tab:hover {
        color: var(--accent-blue);
      }

      .tab.active {
        color: var(--accent-blue);
        border-bottom-color: var(--accent-blue);
      }

      .card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .card h2 {
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .card h3 {
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: var(--accent-blue);
      }

      .account-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
      }

      .account-item {
        text-align: center;
        padding: 1.5rem;
        background: rgba(99, 102, 241, 0.05);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }

      .account-item .label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }

      .account-item .value {
        font-size: 1.75rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: rgba(99, 102, 241, 0.1);
      }

      th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--accent-blue);
        border-bottom: 2px solid var(--border-color);
      }

      td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      tr:hover {
        background: rgba(99, 102, 241, 0.05);
      }

      .symbol {
        font-weight: 600;
        color: var(--accent-blue);
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .badge.long {
        background: rgba(16, 185, 129, 0.2);
        color: var(--profit-green);
      }
      .badge.short {
        background: rgba(239, 68, 68, 0.2);
        color: var(--loss-red);
      }

      .profit {
        color: var(--profit-green);
        font-weight: 600;
      }
      .loss {
        color: var(--loss-red);
        font-weight: 600;
      }

      .signals-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
      }

      .signals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }

      .signal-card {
        background: rgba(99, 102, 241, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        transition: all 0.2s;
      }

      .signal-card:hover {
        background: rgba(99, 102, 241, 0.1);
        transform: scale(1.02);
      }

      .signal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .signal-symbol {
        font-weight: 700;
        font-size: 1.1rem;
      }

      .signal-prob {
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
      }

      .signal-prob.long {
        background: rgba(16, 185, 129, 0.2);
        color: var(--profit-green);
      }
      .signal-prob.short {
        background: rgba(239, 68, 68, 0.2);
        color: var(--loss-red);
      }

      .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
      }

      .loading,
      .error {
        text-align: center;
        padding: 3rem;
        font-size: 1.25rem;
      }

      .error {
        color: var(--loss-red);
      }

      .info-box {
        background: rgba(99, 102, 241, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: var(--text-secondary);
      }

      .info-value {
        font-weight: 600;
      }

      .prediction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .metric-card {
        background: rgba(99, 102, 241, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
      }

      .metric-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }

      .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .metric-value.green {
        color: var(--profit-green);
      }

      .metric-value.red {
        color: var(--loss-red);
      }

      .metric-value.orange {
        color: var(--warning-orange);
      }

      .timestamp {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // API è°ƒç”¨
      const api = {
        async getAccount() {
          const res = await fetch("/api/account");
          return res.json();
        },
        async getPositions() {
          const res = await fetch("/api/positions");
          return res.json();
        },
        async getSignals() {
          const res = await fetch("/api/signals");
          return res.json();
        },
        async getStatus() {
          const res = await fetch("/api/status");
          return res.json();
        },
        async runPrediction() {
          const res = await fetch("/api/predict");
          return res.json();
        },
        async getL1Debug() {
          const res = await fetch("/api/models/l1");
          return res.json();
        },
        async getL2Debug() {
          const res = await fetch("/api/models/l2");
          return res.json();
        },
        async getL3Debug() {
          const res = await fetch("/api/models/l3");
          return res.json();
        },
        async getL4Debug() {
          const res = await fetch("/api/models/l4");
          return res.json();
        },
      };

      // Headerç»„ä»¶
      function Header({ status, onRefresh }) {
        const isMarketOpen = status?.is_market_open || false;
        const l1Safe = status?.l1_safe || false;
        const lastUpdate = status?.last_update;

        return (
          <header className="header">
            <div className="header-content">
              <h1>ğŸ“Š Algo Trade Dashboard</h1>
              <div className="header-info">
                <div
                  className={`status-badge ${isMarketOpen ? "open" : "closed"}`}
                >
                  {isMarketOpen ? "âœ… å¸‚åœºå¼€æ”¾" : "â¸ï¸ å¸‚åœºå…³é—­"}
                </div>
                <div className={`status-badge ${l1Safe ? "safe" : "unsafe"}`}>
                  L1: {l1Safe ? "âœ… å®‰å…¨" : "âš ï¸ è°¨æ…"}
                </div>
                {lastUpdate && (
                  <div
                    style={{
                      color: "var(--text-secondary)",
                      fontSize: "0.85rem",
                    }}
                  >
                    æ›´æ–°: {new Date(lastUpdate).toLocaleTimeString("zh-CN")}
                  </div>
                )}
                <button className="btn" onClick={onRefresh}>
                  ğŸ”„ åˆ·æ–°
                </button>
              </div>
            </div>
          </header>
        );
      }

      // ä»ªè¡¨ç›˜æ ‡ç­¾é¡µ
      function DashboardTab({ account, positions, signals }) {
        return (
          <>
            <AccountCard account={account} />
            <PositionsTable positions={positions} />
            <SignalsPanel signals={signals} />
          </>
        );
      }

      function AccountCard({ account }) {
        const { equity = 0, cash = 0, buying_power = 0 } = account || {};

        return (
          <div className="card">
            <h2>ğŸ’° è´¦æˆ·æ¦‚è§ˆ</h2>
            <div className="account-grid">
              <div className="account-item">
                <div className="label">æ€»æƒç›Š</div>
                <div className="value">
                  $
                  {equity.toLocaleString("en-US", { minimumFractionDigits: 2 })}
                </div>
              </div>
              <div className="account-item">
                <div className="label">ç°é‡‘</div>
                <div className="value">
                  ${cash.toLocaleString("en-US", { minimumFractionDigits: 2 })}
                </div>
              </div>
              <div className="account-item">
                <div className="label">è´­ä¹°åŠ›</div>
                <div className="value">
                  $
                  {buying_power.toLocaleString("en-US", {
                    minimumFractionDigits: 2,
                  })}
                </div>
              </div>
            </div>
          </div>
        );
      }

      function PositionsTable({ positions }) {
        if (!positions || positions.length === 0) {
          return (
            <div className="card">
              <h2>ğŸ“¦ å½“å‰æŒä»“</h2>
              <div className="empty-state">æš‚æ— æŒä»“</div>
            </div>
          );
        }

        return (
          <div className="card">
            <h2>ğŸ“¦ å½“å‰æŒä»“ ({positions.length})</h2>
            <table>
              <thead>
                <tr>
                  <th>æ ‡çš„</th>
                  <th>æ–¹å‘</th>
                  <th>æ•°é‡</th>
                  <th>æˆæœ¬ä»·</th>
                  <th>ç°ä»·</th>
                  <th>ç›ˆäº</th>
                  <th>ç›ˆäºç‡</th>
                </tr>
              </thead>
              <tbody>
                {positions.map((pos, idx) => {
                  const pnl = parseFloat(pos.unrealized_pl || 0);
                  const pnlPct = parseFloat(pos.unrealized_plpc || 0) * 100;
                  const pnlClass = pnl >= 0 ? "profit" : "loss";

                  return (
                    <tr key={idx}>
                      <td className="symbol">{pos.symbol}</td>
                      <td>
                        <span className={`badge ${pos.side}`}>
                          {pos.side === "long" ? "åšå¤š" : "åšç©º"}
                        </span>
                      </td>
                      <td>{pos.qty}</td>
                      <td>
                        ${parseFloat(pos.avg_entry_price || 0).toFixed(2)}
                      </td>
                      <td>${parseFloat(pos.current_price || 0).toFixed(2)}</td>
                      <td className={pnlClass}>${pnl.toFixed(2)}</td>
                      <td className={pnlClass}>
                        {pnlPct >= 0 ? "+" : ""}
                        {pnlPct.toFixed(2)}%
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        );
      }

      function SignalsPanel({ signals }) {
        const { long = [], short = [] } = signals || {};

        const renderSignals = (signalList, type) => {
          if (signalList.length === 0) {
            return (
              <div className="empty-state">
                æš‚æ— {type === "long" ? "åšå¤š" : "åšç©º"}ä¿¡å·
              </div>
            );
          }

          return (
            <div className="signals-grid">
              {signalList.map((signal, idx) => {
                const prob = parseFloat(signal[`${type}_p`] || 0) * 100;

                return (
                  <div key={idx} className="signal-card">
                    <div className="signal-header">
                      <span className="signal-symbol">{signal.symbol}</span>
                      <span className={`signal-prob ${type}`}>
                        {prob.toFixed(1)}%
                      </span>
                    </div>
                    <div
                      style={{
                        color: "var(--text-secondary)",
                        fontSize: "0.875rem",
                      }}
                    >
                      ç°ä»·: ${parseFloat(signal.close || 0).toFixed(2)}
                    </div>
                  </div>
                );
              })}
            </div>
          );
        };

        return (
          <div className="signals-wrapper">
            <div className="card">
              <h2>ğŸ“ˆ åšå¤šä¿¡å· (Top {long.length})</h2>
              {renderSignals(long, "long")}
            </div>
            <div className="card">
              <h2>ğŸ“‰ åšç©ºä¿¡å· (Top {short.length})</h2>
              {renderSignals(short, "short")}
            </div>
          </div>
        );
      }

      // é¢„æµ‹ä¸­å¿ƒæ ‡ç­¾é¡µ
      function PredictionTab({ onRunPrediction, predicting }) {
        const [predictionData, setPredictionData] = useState(null);
        const [l1Data, setL1Data] = useState(null);
        const [l4Data, setL4Data] = useState(null);

        const runPrediction = async () => {
          try {
            const result = await onRunPrediction();
            setPredictionData(result);

            // è·å–L1å’ŒL4è¯¦æƒ…
            const l1 = await api.getL1Debug();
            const l4 = await api.getL4Debug();
            setL1Data(l1);
            setL4Data(l4);
          } catch (err) {
            console.error("Prediction failed:", err);
          }
        };

        return (
          <div className="card">
            <div className="prediction-header">
              <h2>ğŸ”® é¢„æµ‹ä¸­å¿ƒ</h2>
              <button
                className="btn"
                onClick={runPrediction}
                disabled={predicting}
              >
                {predicting ? "â³ é¢„æµ‹ä¸­..." : "â–¶ï¸ è¿è¡Œé¢„æµ‹"}
              </button>
            </div>

            {!predictionData && (
              <div className="empty-state">ç‚¹å‡»"è¿è¡Œé¢„æµ‹"å¼€å§‹åˆ†æ</div>
            )}

            {predictionData && (
              <>
                <div className="timestamp">
                  ğŸ“… é¢„æµ‹æ—¶é—´:{" "}
                  {new Date(predictionData.timestamp).toLocaleString("zh-CN")}
                </div>

                <h3>L1 å¸‚åœºæ‹©æ—¶</h3>
                <div className="metric-grid">
                  <div className="metric-card">
                    <div className="metric-label">å¸‚åœºçŠ¶æ€</div>
                    <div
                      className={`metric-value ${
                        predictionData.l1_safe ? "green" : "orange"
                      }`}
                    >
                      {predictionData.l1_safe ? "âœ… å®‰å…¨" : "âš ï¸ è°¨æ…"}
                    </div>
                  </div>
                  <div className="metric-card">
                    <div className="metric-label">ç½®ä¿¡åº¦</div>
                    <div className="metric-value">
                      {(predictionData.l1_prob * 100).toFixed(1)}%
                    </div>
                  </div>
                </div>

                {l4Data && (
                  <>
                    <h3>L4 äº¤æ˜“å»ºè®®</h3>

                    {l4Data.long_recommendations &&
                      l4Data.long_recommendations.length > 0 && (
                        <>
                          <h4
                            style={{
                              color: "var(--profit-green)",
                              marginTop: "1rem",
                            }}
                          >
                            ğŸ“ˆ åšå¤šå»ºè®® (Top{" "}
                            {l4Data.long_recommendations.length})
                          </h4>
                          <table>
                            <thead>
                              <tr>
                                <th>æ ‡çš„</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>é¢„æœŸæ”¶ç›Š</th>
                                <th>ä»“ä½</th>
                                <th>æ­¢ç›ˆ</th>
                                <th>æ­¢æŸ</th>
                                <th>ç›ˆäºæ¯”</th>
                              </tr>
                            </thead>
                            <tbody>
                              {l4Data.long_recommendations.map((rec, idx) => (
                                <tr key={idx}>
                                  <td className="symbol">{rec.symbol}</td>
                                  <td className="profit">
                                    {(rec.confidence * 100).toFixed(1)}%
                                  </td>
                                  <td className="profit">
                                    +{(rec.predicted_return * 100).toFixed(2)}%
                                  </td>
                                  <td>{(rec.allocation * 100).toFixed(0)}%</td>
                                  <td className="profit">
                                    ${rec.take_profit.toFixed(2)} (
                                    {(rec.tp_pct * 100).toFixed(1)}%)
                                  </td>
                                  <td className="loss">
                                    ${rec.stop_loss.toFixed(2)} (
                                    {(rec.sl_pct * 100).toFixed(1)}%)
                                  </td>
                                  <td>{rec.risk_reward.toFixed(2)}:1</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </>
                      )}

                    {l4Data.short_recommendations &&
                      l4Data.short_recommendations.length > 0 && (
                        <>
                          <h4
                            style={{
                              color: "var(--loss-red)",
                              marginTop: "1.5rem",
                            }}
                          >
                            ğŸ“‰ åšç©ºå»ºè®® (Top{" "}
                            {l4Data.short_recommendations.length})
                          </h4>
                          <table>
                            <thead>
                              <tr>
                                <th>æ ‡çš„</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>é¢„æœŸè·Œå¹…</th>
                                <th>ä»“ä½</th>
                                <th>æ­¢ç›ˆ</th>
                                <th>æ­¢æŸ</th>
                                <th>ç›ˆäºæ¯”</th>
                              </tr>
                            </thead>
                            <tbody>
                              {l4Data.short_recommendations.map((rec, idx) => (
                                <tr key={idx}>
                                  <td className="symbol">{rec.symbol}</td>
                                  <td className="loss">
                                    {(rec.confidence * 100).toFixed(1)}%
                                  </td>
                                  <td className="loss">
                                    {(rec.predicted_return * 100).toFixed(2)}%
                                  </td>
                                  <td>{(rec.allocation * 100).toFixed(0)}%</td>
                                  <td className="profit">
                                    ${rec.take_profit.toFixed(2)} (
                                    {(rec.tp_pct * 100).toFixed(1)}%)
                                  </td>
                                  <td className="loss">
                                    ${rec.stop_loss.toFixed(2)} (
                                    {(rec.sl_pct * 100).toFixed(1)}%)
                                  </td>
                                  <td>{rec.risk_reward.toFixed(2)}:1</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </>
                      )}

                    {(!l4Data.long_recommendations ||
                      l4Data.long_recommendations.length === 0) &&
                      (!l4Data.short_recommendations ||
                        l4Data.short_recommendations.length === 0) && (
                        <div className="empty-state">
                          å½“å‰æ— é«˜ç½®ä¿¡åº¦äº¤æ˜“ä¿¡å·
                        </div>
                      )}
                  </>
                )}
              </>
            )}
          </div>
        );
      }

      // L1è°ƒè¯•æ ‡ç­¾é¡µ
      function L1DebugTab() {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          loadData();
        }, []);

        const loadData = async () => {
          setLoading(true);
          try {
            const result = await api.getL1Debug();
            setData(result);
          } catch (err) {
            console.error("Failed to load L1 data:", err);
          }
          setLoading(false);
        };

        if (loading) {
          return <div className="loading">â³ åŠ è½½ä¸­...</div>;
        }

        if (!data) {
          return (
            <div className="card">
              <h2>L1 å¸‚åœºæ‹©æ—¶è°ƒè¯•</h2>
              <div className="empty-state">
                è¯·å…ˆè¿è¡Œé¢„æµ‹ä»¥æŸ¥çœ‹L1è¯¦æƒ…
                <br />
                <button
                  className="btn"
                  onClick={loadData}
                  style={{ marginTop: "1rem" }}
                >
                  å°è¯•åŠ è½½
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="card">
            <h2>L1 å¸‚åœºæ‹©æ—¶è°ƒè¯•</h2>

            <div className="metric-grid">
              <div className="metric-card">
                <div className="metric-label">å¸‚åœºç¯å¢ƒ</div>
                <div
                  className={`metric-value ${data.safe ? "green" : "orange"}`}
                >
                  {data.safe ? "âœ… å®‰å…¨" : "âš ï¸ ä¸å®‰å…¨"}
                </div>
              </div>
              <div className="metric-card">
                <div className="metric-label">ç½®ä¿¡åº¦</div>
                <div className="metric-value">
                  {(data.probability * 100).toFixed(2)}%
                </div>
              </div>
              <div className="metric-card">
                <div className="metric-label">é˜ˆå€¼</div>
                <div className="metric-value">
                  {(data.threshold * 100).toFixed(0)}%
                </div>
              </div>
            </div>

            <div className="info-box" style={{ marginTop: "1.5rem" }}>
              <h3>è¯´æ˜</h3>
              <p style={{ color: "var(--text-secondary)", lineHeight: 1.6 }}>
                L1å±‚ä½¿ç”¨å®è§‚å¸‚åœºæŒ‡æ ‡ï¼ˆSPY, VIXY,
                TLTç­‰ï¼‰åˆ¤æ–­å¸‚åœºç¯å¢ƒæ˜¯å¦é€‚åˆäº¤æ˜“ã€‚
                å½“ç½®ä¿¡åº¦é«˜äºé˜ˆå€¼æ—¶ï¼Œåˆ¤å®šå¸‚åœºå®‰å…¨ï¼Œå…è®¸åšå¤šæ“ä½œã€‚
              </p>
            </div>
          </div>
        );
      }

      // L2è°ƒè¯•æ ‡ç­¾é¡µ
      function L2DebugTab() {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          loadData();
        }, []);

        const loadData = async () => {
          setLoading(true);
          try {
            const result = await api.getL2Debug();
            setData(result);
          } catch (err) {
            console.error("Failed to load L2 data:", err);
          }
          setLoading(false);
        };

        if (loading) {
          return <div className="loading">â³ åŠ è½½ä¸­...</div>;
        }

        if (!data || !data.stocks || data.stocks.length === 0) {
          return (
            <div className="card">
              <h2>L2 æ ‡çš„ç­›é€‰è°ƒè¯•</h2>
              <div className="empty-state">
                è¯·å…ˆè¿è¡Œé¢„æµ‹ä»¥æŸ¥çœ‹L2è¯¦æƒ…
                <br />
                <button
                  className="btn"
                  onClick={loadData}
                  style={{ marginTop: "1rem" }}
                >
                  å°è¯•åŠ è½½
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="card">
            <h2>L2 æ ‡çš„ç­›é€‰è°ƒè¯•</h2>
            {data.timestamp && (
              <div className="timestamp">
                ğŸ“… æ•°æ®æ—¶é—´: {new Date(data.timestamp).toLocaleString("zh-CN")}
              </div>
            )}

            <table>
              <thead>
                <tr>
                  <th>æ’å</th>
                  <th>æ ‡çš„</th>
                  <th>ä»·æ ¼</th>
                  <th>ç›¸å¯¹å¼ºåº¦å¾—åˆ†</th>
                </tr>
              </thead>
              <tbody>
                {data.stocks.map((stock, idx) => (
                  <tr key={idx}>
                    <td>{stock.rank}</td>
                    <td className="symbol">{stock.symbol}</td>
                    <td>${stock.close.toFixed(2)}</td>
                    <td>
                      <span
                        className={stock.rank_score > 0 ? "profit" : "loss"}
                      >
                        {stock.rank_score > 0 ? "ğŸ“ˆ" : "ğŸ“‰"}{" "}
                        {stock.rank_score.toFixed(4)}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            <div className="info-box" style={{ marginTop: "1.5rem" }}>
              <h3>è¯´æ˜</h3>
              <p style={{ color: "var(--text-secondary)", lineHeight: 1.6 }}>
                L2å±‚ä½¿ç”¨15åˆ†é’ŸKçº¿æ•°æ®å¯¹æ ‡çš„è¿›è¡Œç›¸å¯¹å¼ºåº¦æ’åã€‚
                æ’åé å‰çš„æ ‡çš„å…·æœ‰æ›´å¼ºçš„åŠ¨é‡ï¼Œæ›´æœ‰å¯èƒ½äº§ç”Ÿäº¤æ˜“æœºä¼šã€‚
              </p>
            </div>
          </div>
        );
      }

      // L3è°ƒè¯•æ ‡ç­¾é¡µ
      function L3DebugTab() {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          loadData();
        }, []);

        const loadData = async () => {
          setLoading(true);
          try {
            const result = await api.getL3Debug();
            setData(result);
          } catch (err) {
            console.error("Failed to load L3 data:", err);
          }
          setLoading(false);
        };

        if (loading) {
          return <div className="loading">â³ åŠ è½½ä¸­...</div>;
        }

        if (!data || !data.signals || data.signals.length === 0) {
          return (
            <div className="card">
              <h2>L3 è¶‹åŠ¿ç¡®è®¤è°ƒè¯•</h2>
              <div className="empty-state">
                è¯·å…ˆè¿è¡Œé¢„æµ‹ä»¥æŸ¥çœ‹L3è¯¦æƒ…
                <br />
                <button
                  className="btn"
                  onClick={loadData}
                  style={{ marginTop: "1rem" }}
                >
                  å°è¯•åŠ è½½
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="card">
            <h2>L3 è¶‹åŠ¿ç¡®è®¤è°ƒè¯•</h2>
            {data.timestamp && (
              <div className="timestamp">
                ğŸ“… æ•°æ®æ—¶é—´: {new Date(data.timestamp).toLocaleString("zh-CN")}{" "}
                | ä¿¡å·é˜ˆå€¼: {(data.signal_threshold * 100).toFixed(0)}%
              </div>
            )}

            <table>
              <thead>
                <tr>
                  <th>æ ‡çš„</th>
                  <th>ä»·æ ¼</th>
                  <th>åšå¤šç½®ä¿¡åº¦</th>
                  <th>åšç©ºç½®ä¿¡åº¦</th>
                  <th>æ´—ç›˜æ£€æµ‹</th>
                </tr>
              </thead>
              <tbody>
                {data.signals.map((signal, idx) => (
                  <tr key={idx}>
                    <td className="symbol">{signal.symbol}</td>
                    <td>${signal.close.toFixed(2)}</td>
                    <td>
                      <span
                        className={
                          signal.long_p > data.signal_threshold ? "profit" : ""
                        }
                      >
                        {(signal.long_p * 100).toFixed(2)}%
                        {signal.long_p > data.signal_threshold && " âœ…"}
                      </span>
                    </td>
                    <td>
                      <span
                        className={
                          signal.short_p > data.signal_threshold ? "loss" : ""
                        }
                      >
                        {(signal.short_p * 100).toFixed(2)}%
                        {signal.short_p > data.signal_threshold && " âœ…"}
                      </span>
                    </td>
                    <td>
                      {signal.shakeout === "Bullish Shakeout" && "ğŸ® çœ‹æ¶¨æ´—ç›˜"}
                      {signal.shakeout === "Bearish Trap" && "ğŸ» çœ‹è·Œé™·é˜±"}
                      {signal.shakeout === "None" && "-"}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            <div className="info-box" style={{ marginTop: "1.5rem" }}>
              <h3>è¯´æ˜</h3>
              <p style={{ color: "var(--text-secondary)", lineHeight: 1.6 }}>
                L3å±‚ä½¿ç”¨1åˆ†é’ŸKçº¿æ•°æ®è¿›è¡Œè¶‹åŠ¿ç¡®è®¤ï¼Œé¢„æµ‹åšå¤šå’Œåšç©ºçš„ç½®ä¿¡åº¦ã€‚
                å½“ç½®ä¿¡åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆ{(data.signal_threshold * 100).toFixed(0)}
                %ï¼‰æ—¶ï¼Œè®¤ä¸ºæ˜¯é«˜ç½®ä¿¡åº¦ä¿¡å·ã€‚
                æ´—ç›˜æ£€æµ‹ç”¨äºè¯†åˆ«æ½œåœ¨çš„å‡çªç ´å’Œå¸‚åœºé™·é˜±ã€‚
              </p>
            </div>
          </div>
        );
      }

      // L4è°ƒè¯•æ ‡ç­¾é¡µ
      function L4DebugTab() {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
          loadData();
        }, []);

        const loadData = async () => {
          setLoading(true);
          try {
            const result = await api.getL4Debug();
            setData(result);
          } catch (err) {
            console.error("Failed to load L4 data:", err);
          }
          setLoading(false);
        };

        if (loading) {
          return <div className="loading">â³ åŠ è½½ä¸­...</div>;
        }

        if (!data) {
          return (
            <div className="card">
              <h2>L4 é£æ§å»ºè®®è°ƒè¯•</h2>
              <div className="empty-state">
                è¯·å…ˆè¿è¡Œé¢„æµ‹ä»¥æŸ¥çœ‹L4è¯¦æƒ…
                <br />
                <button
                  className="btn"
                  onClick={loadData}
                  style={{ marginTop: "1rem" }}
                >
                  å°è¯•åŠ è½½
                </button>
              </div>
            </div>
          );
        }

        const hasLong =
          data.long_recommendations && data.long_recommendations.length > 0;
        const hasShort =
          data.short_recommendations && data.short_recommendations.length > 0;

        return (
          <div className="card">
            <h2>L4 é£æ§å»ºè®®è°ƒè¯•</h2>
            <div className="timestamp">Top N äº¤æ˜“æ•°é‡: {data.top_n}</div>

            {hasLong && (
              <>
                <h3 style={{ color: "var(--profit-green)" }}>
                  ğŸ“ˆ åšå¤šå»ºè®®è¯¦æƒ…
                </h3>
                <table>
                  <thead>
                    <tr>
                      <th>æ ‡çš„</th>
                      <th>ç½®ä¿¡åº¦</th>
                      <th>é¢„æœŸæ”¶ç›Š</th>
                      <th>å»ºè®®ä»“ä½</th>
                      <th>å½“å‰ä»·æ ¼</th>
                      <th>æ­¢ç›ˆä»·æ ¼</th>
                      <th>æ­¢æŸä»·æ ¼</th>
                      <th>ç›ˆäºæ¯”</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.long_recommendations.map((rec, idx) => (
                      <tr key={idx}>
                        <td className="symbol">{rec.symbol}</td>
                        <td className="profit">
                          {(rec.confidence * 100).toFixed(1)}%
                        </td>
                        <td className="profit">
                          +{(rec.predicted_return * 100).toFixed(2)}%
                        </td>
                        <td>{(rec.allocation * 100).toFixed(1)}%</td>
                        <td>${rec.current_price.toFixed(2)}</td>
                        <td className="profit">
                          ${rec.take_profit.toFixed(2)}
                          <br />
                          <small>({(rec.tp_pct * 100).toFixed(1)}%)</small>
                        </td>
                        <td className="loss">
                          ${rec.stop_loss.toFixed(2)}
                          <br />
                          <small>({(rec.sl_pct * 100).toFixed(1)}%)</small>
                        </td>
                        <td>{rec.risk_reward.toFixed(2)}:1</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </>
            )}

            {hasShort && (
              <>
                <h3 style={{ color: "var(--loss-red)", marginTop: "1.5rem" }}>
                  ğŸ“‰ åšç©ºå»ºè®®è¯¦æƒ…
                </h3>
                <table>
                  <thead>
                    <tr>
                      <th>æ ‡çš„</th>
                      <th>ç½®ä¿¡åº¦</th>
                      <th>é¢„æœŸè·Œå¹…</th>
                      <th>å»ºè®®ä»“ä½</th>
                      <th>å½“å‰ä»·æ ¼</th>
                      <th>æ­¢ç›ˆä»·æ ¼</th>
                      <th>æ­¢æŸä»·æ ¼</th>
                      <th>ç›ˆäºæ¯”</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.short_recommendations.map((rec, idx) => (
                      <tr key={idx}>
                        <td className="symbol">{rec.symbol}</td>
                        <td className="loss">
                          {(rec.confidence * 100).toFixed(1)}%
                        </td>
                        <td className="loss">
                          {(rec.predicted_return * 100).toFixed(2)}%
                        </td>
                        <td>{(rec.allocation * 100).toFixed(1)}%</td>
                        <td>${rec.current_price.toFixed(2)}</td>
                        <td className="profit">
                          ${rec.take_profit.toFixed(2)}
                          <br />
                          <small>({(rec.tp_pct * 100).toFixed(1)}%)</small>
                        </td>
                        <td className="loss">
                          ${rec.stop_loss.toFixed(2)}
                          <br />
                          <small>({(rec.sl_pct * 100).toFixed(1)}%)</small>
                        </td>
                        <td>{rec.risk_reward.toFixed(2)}:1</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </>
            )}

            {!hasLong && !hasShort && (
              <div className="empty-state">å½“å‰æ— é«˜ç½®ä¿¡åº¦äº¤æ˜“å»ºè®®</div>
            )}

            <div className="info-box" style={{ marginTop: "1.5rem" }}>
              <h3>è¯´æ˜</h3>
              <p style={{ color: "var(--text-secondary)", lineHeight: 1.6 }}>
                L4å±‚ç»“åˆL1-L3çš„ä¿¡å·ï¼Œä½¿ç”¨SMCï¼ˆSmart Money
                Conceptsï¼‰è§„åˆ™è®¡ç®—æ­¢ç›ˆæ­¢æŸä»·ä½ã€‚
                é¢„æœŸæ”¶ç›ŠåŸºäºå†å²æ•°æ®è®­ç»ƒçš„æ¨¡å‹é¢„æµ‹ï¼Œä»“ä½åˆ†é…æ ¹æ®é¢„æœŸæ”¶ç›Šå’Œå¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ã€‚
                ç›ˆäºæ¯”æ˜¯æ½œåœ¨æ”¶ç›Šä¸é£é™©çš„æ¯”ç‡ï¼Œé€šå¸¸å»ºè®®é€‰æ‹©ç›ˆäºæ¯” â‰¥ 2:1 çš„äº¤æ˜“ã€‚
              </p>
            </div>
          </div>
        );
      }

      // ä¸»åº”ç”¨
      function App() {
        const [activeTab, setActiveTab] = useState("dashboard");
        const [account, setAccount] = useState(null);
        const [positions, setPositions] = useState([]);
        const [signals, setSignals] = useState({ long: [], short: [] });
        const [status, setStatus] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [predicting, setPredicting] = useState(false);

        const fetchData = async () => {
          try {
            setLoading(true);
            setError(null);

            const [accountData, positionsData, signalsData, statusData] =
              await Promise.all([
                api.getAccount(),
                api.getPositions(),
                api.getSignals(),
                api.getStatus(),
              ]);

            setAccount(accountData);
            setPositions(positionsData);
            setSignals(signalsData);
            setStatus(statusData);
          } catch (err) {
            setError(err.message);
            console.error("Failed to fetch data:", err);
          } finally {
            setLoading(false);
          }
        };

        const runPrediction = async () => {
          setPredicting(true);
          try {
            const result = await api.runPrediction();
            return result;
          } catch (err) {
            setError("é¢„æµ‹å¤±è´¥: " + err.message);
            throw err;
          } finally {
            setPredicting(false);
          }
        };

        useEffect(() => {
          fetchData();
          const interval = setInterval(fetchData, 30000); // 30ç§’åˆ·æ–°
          return () => clearInterval(interval);
        }, []);

        const tabs = [
          { id: "dashboard", label: "ğŸ“Š ä»ªè¡¨ç›˜", icon: "ğŸ“Š" },
          { id: "prediction", label: "ğŸ”® é¢„æµ‹ä¸­å¿ƒ", icon: "ğŸ”®" },
          { id: "l1", label: "L1 æ‹©æ—¶", icon: "ğŸ“ˆ" },
          { id: "l2", label: "L2 ç­›é€‰", icon: "ğŸ¯" },
          { id: "l3", label: "L3 è¶‹åŠ¿", icon: "ğŸ“‰" },
          { id: "l4", label: "L4 é£æ§", icon: "ğŸ›¡ï¸" },
        ];

        return (
          <>
            <Header status={status} onRefresh={fetchData} />
            <main className="container">
              {error && (
                <div className="error">
                  âš ï¸ {error}
                  <br />
                  <button
                    className="btn"
                    onClick={fetchData}
                    style={{ marginTop: "1rem" }}
                  >
                    é‡è¯•
                  </button>
                </div>
              )}

              <div className="tabs">
                {tabs.map((tab) => (
                  <button
                    key={tab.id}
                    className={`tab ${activeTab === tab.id ? "active" : ""}`}
                    onClick={() => setActiveTab(tab.id)}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {loading && !account && activeTab === "dashboard" && (
                <div className="loading">â³ åŠ è½½ä¸­...</div>
              )}

              {activeTab === "dashboard" && account && (
                <DashboardTab
                  account={account}
                  positions={positions}
                  signals={signals}
                />
              )}

              {activeTab === "prediction" && (
                <PredictionTab
                  onRunPrediction={runPrediction}
                  predicting={predicting}
                />
              )}

              {activeTab === "l1" && <L1DebugTab />}
              {activeTab === "l2" && <L2DebugTab />}
              {activeTab === "l3" && <L3DebugTab />}
              {activeTab === "l4" && <L4DebugTab />}
            </main>
          </>
        );
      }

      // æ¸²æŸ“
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
